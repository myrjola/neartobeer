version: 2
jobs:
  build:
    docker:
      - image: myrjola/react-native-android-appium:v0.3
    working_directory: "/root/beersunderx"
    environment:
      QEMU_AUDIO_DRV: none
      LC_ALL: "C.UTF-8"
    steps:
      - run:
          name: Start emulator, it takes long to start
          command: |
            /opt/android/emulator/emulator \
              -avd testAVD \
              -no-audio \
              -no-window
          background: true
      - checkout
      - restore_cache:
          key: beersunderx-node-dependencies-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Create artifacts directory
          command: mkdir -p artifacts
      - run:
          name: Install Dependencies
          command: yarn install
      - save_cache:
          key: beersunderx-node-dependencies-{{ .Branch }}-{{ checksum "yarn.lock" }}
          paths:
            - node_modules
            - ~/.npm
            - ~/.cache/yarn
            - /usr/local/lib/node_modules/
      - restore_cache:
          key: beersunderx-{{ .Branch }}-jest
      - run:
          name: NPM Test
          command: npm test
      - save_cache:
          key: beersunderx-{{ .Branch }}-jest-{{ epoch }}
          paths:
            - .jest-cache
      - run:
          name: Create integration test keystore
          command: |
            cd android/app && \
              keytool -genkey -v -keystore beersunderx.keystore \
                -alias beersunderx -keyalg RSA -keysize 2048 \
                -keypass android -storepass android \
                -dname "CN=Android Integrationtest,O=BeersUnderX,C=SE"
      - run:
          name: Set the correct signing settings
          command: |
            cp android/app/local.properties.integration \
               android/app/local.properties
      - restore_cache:
          key: beersunderx-gradle-{{ .Branch }}-{{ checksum "android/app/build.gradle" }}
      - run:
          name: Assemble APKs
          command: cd android && ./gradlew assemble
          environment:
            TERM: dumb
      - save_cache:
          key: beersunderx-gradle-{{ .Branch }}-{{ checksum "android/app/build.gradle" }}
          paths:
            - ~/.gradle
            - android/build
            - android/app/build
      - run:
          name: Check that emulator is ready
          command: source scripts/funcs.bash && waitForAVD
      - run:
          name: Take screenshot
          command: |
            adb shell screencap -p | \
              perl -pe 's/\x0D\x0A/\x0A/g' > \
                artifacts/screen-$(date -I).png
      - run:
          name: Integration tests
          command: npm run test:integration
      - store_artifacts:
          path: artifacts
